# ูุธุงู ุฅุนุฏุงุฏ ุดูุงุฏุฉ ZATCA - ุฏููู ุงูุงุณุชุฎุฏุงู

## ูุธุฑุฉ ุนุงูุฉ

ุชู ุฅูุดุงุก ูุธุงู ุดุงูู ูุฅุนุฏุงุฏ ูุฅุฏุงุฑุฉ ุดูุงุฏุงุช ููุฆุฉ ุงูุฒูุงุฉ ูุงูุถุฑูุจุฉ ูุงูุฌูุงุฑู ุงูุณุนูุฏูุฉ (ZATCA) ุจุงุณุชุฎุฏุงู ุญุฒูุฉ Salla/ZATCA. ูููุฑ ุงููุธุงู ูุงุฌูุฉ ูุณุชุฎุฏู ุนุฑุจูุฉ ูุชูุงููุฉ ูุฅูุดุงุก ุทูุจุงุช ุงูุดูุงุฏุฉ (CSR) ูุฅุฏุงุฑุฉ ุงููููุงุช ุงููุทููุจุฉ.

## ุงูููุฒุงุช ุงูุฑุฆูุณูุฉ

### ๐ฏ ุงููููุฐุฌ ุงูุชูุงุนูู
- ูุงุฌูุฉ ูุณุชุฎุฏู ุนุฑุจูุฉ (RTL) ูุตููุฉ ุฎุตูุตุงู ูููุณุชุฎุฏููู ุงูุณุนูุฏููู
- ูุฆุงุช ูุดุงุท ุชุฌุงุฑู ูุญุฏุฏุฉ ูุณุจูุงู
- ุชุญูู ุชููุงุฆู ูู ุตุญุฉ ุงูุจูุงูุงุช
- ุชูุณูู ุชููุงุฆู ูุฑูู ุถุฑูุจุฉ ุงููููุฉ ุงููุถุงูุฉ

### ๐ ุฅุฏุงุฑุฉ ุงูุดูุงุฏุงุช
- ุฅูุดุงุก ุงูููุชุงุญ ุงูุฎุงุต (Private Key) ุจุดูู ุขูู
- ุชูููุฏ ุทูุจ ุงูุดูุงุฏุฉ (CSR) ุญุณุจ ูุนุงููุฑ ZATCA
- ุญูุธ ุชููุงุฆู ูููููุงุช ูุน timestamp
- ุฅููุงููุฉ ุชุญููู ุงููููุงุช ุจุตูุบ ูุชุนุฏุฏุฉ

### ๐ ุจูุฆุงุช ูุชุนุฏุฏุฉ
- ุฏุนู ุจูุฆุฉ ุงูุชุฌุฑูุจ (Sandbox)
- ุฏุนู ุจูุฆุฉ ุงูุฅูุชุงุฌ (Production)
- ูุญุงูุงุฉ ุฅุฑุณุงู ููู API ูู ุจูุฆุฉ ุงูุชุฌุฑูุจ

### ๐ ุชุชุจุน ููุฑุงูุจุฉ
- ุณุฌูุงุช ููุตูุฉ ููุนูููุงุช
- ูุนูููุงุช ูุตููุฉ ูููููุงุช ุงูููุดุฃุฉ
- ุฅุฏุงุฑุฉ ุชููุงุฆูุฉ ูููููุงุช ุงููุฏููุฉ

## ุงูุชุซุจูุช ูุงูุฅุนุฏุงุฏ

### 1. ุชุฃูุฏ ูู ูุฌูุฏ ุงูุญุฒู ุงููุทููุจุฉ

```bash
composer install
```

ุงูุญุฒู ุงููุทููุจุฉ:
- `salla/zatca: ^3.0` (ูุซุจุชุฉ ูุณุจูุงู)
- Laravel Framework ^11.31
- PHP ^8.2

### 2. ุฅุนุฏุงุฏ ูุชุบูุฑุงุช ุงูุจูุฆุฉ

ุฃุถู ูุฐู ุงููุชุบูุฑุงุช ุฅูู ููู `.env`:

```env
# ZATCA Configuration
ZATCA_ENV=sandbox
ZATCA_SANDBOX_API_URL=https://sandbox-api.fatoora.zatca.gov.sa
ZATCA_SIMULATION_API_URL=https://simulation-api.fatoora.zatca.gov.sa
ZATCA_PROD_API_URL=https://api.fatoora.zatca.gov.sa

# Optional: Pre-fill organization data
ORG_IDENTIFIER=399999999900003
ZATCA_COMMON_NAME=TST-886431145-399999999900003
ZATCA_SERIAL_NUMBER=1-TST
ZATCA_BUSINESS_CATEGORY=Supply activities to support transportation
```

### 3. ุฅูุดุงุก ูุฌูุฏ ุงูุชุฎุฒูู

```bash
php artisan storage:link
mkdir -p storage/app/zatca
chmod 755 storage/app/zatca
```

## ุงูุงุณุชุฎุฏุงู

### 1. ุงููุตูู ูููููุฐุฌ

ุฒุฑ ุงูุฑุงุจุท ุงูุชุงูู ูู ุงููุชุตูุญ:
```
http://your-domain.com/zatca
```

ุฃู ููุชุทููุฑ ุงููุญูู:
```
http://localhost:8000/zatca
```

### 2. ููุก ุงููููุฐุฌ

#### ูุนูููุงุช ุงูุดุฑูุฉ
- **ุงุณู ุงูุดุฑูุฉ**: ุงูุงุณู ุงูุชุฌุงุฑู ููุดุฑูุฉ
- **ุงูุงุณู ุงููุดุชุฑู**: ูุนุฑู ูุฑูุฏ ููุดูุงุฏุฉ (ูููุดุฃ ุชููุงุฆูุงู)
- **ูุนุฑู ุงูุดุฑูุฉ**: ุฑูู ุถุฑูุจุฉ ุงููููุฉ ุงููุถุงูุฉ (15 ุฑูู)
- **ูุฆุฉ ุงููุดุงุท ุงูุชุฌุงุฑู**: ุงุฎุชุฑ ูู ุงููุงุฆูุฉ ุงููุญุฏุฏุฉ ูุณุจูุงู

#### ูุนูููุงุช ุงูุฑูู ุงูุชุณูุณูู
- **ุงูุฑูู ุงูุชุณูุณูู**: ูุนุฑู ุงูุฌูุงุฒ ุฃู ุงููุธุงู (ุงุณู ุงูุญู: TSTุ ุงูุฅุตุฏุงุฑ: 1.0)

#### ุงูุนููุงู ุงููุณุฌู
- **ุงูุนููุงู ุงููุงูู**: ุงูุนููุงู ุงููุณุฌู ูู ุงูุณุฌู ุงูุชุฌุงุฑู

#### ุฃููุงุน ุงูููุงุชูุฑ
- **ุงูููุงุชูุฑ ุงููุจุณุทุฉ**: ูููุจูุนุงุช ุงููุจุงุดุฑุฉ (B2C)
- **ุงูููุงุชูุฑ ุงููุนูุงุฑูุฉ**: ูููุจูุนุงุช ููุดุฑูุงุช (B2B)

### 3. ุฅูุดุงุก ุงูุดูุงุฏุฉ

1. ุงููุฑ ุนูู "ุฅูุดุงุก ุทูุจ ุงูุดูุงุฏุฉ (CSR)"
2. ุงูุชุธุฑ ุญุชู ุงูุชูุงู ุงูุนูููุฉ
3. ุณุชุธูุฑ ุงููุชุงุฆุฌ ุชููุงุฆูุงู ูู ุงูุฃุณูู

### 4. ุญูุธ ุงููููุงุช

ุนูุฏ ุฅูุดุงุก ุงูุดูุงุฏุฉ ุจูุฌุงุญุ ุณุชุญุตู ุนูู:

#### ุงูููุชุงุญ ุงูุฎุงุต (Private Key)
```
-----BEGIN PRIVATE KEY-----
MIIEvgIBADANBgkqhkiG9w0BAQEFAASCBKgwggSkAgEAAoIBAQC...
-----END PRIVATE KEY-----
```

#### ุทูุจ ุงูุดูุงุฏุฉ (CSR)
```
-----BEGIN CERTIFICATE REQUEST-----
MIICXTCCAUUCAQAwGDEWMBQGA1UEAwwNVFNULTg4NjQzMTE0NTCCASIwDQYJKoZI...
-----END CERTIFICATE REQUEST-----
```

**โ๏ธ ููู ุฌุฏุงู:**
- ุงุญูุธ ุงูููุชุงุญ ุงูุฎุงุต ูู ููุงู ุขูู
- ูุง ุชุดุงุฑู ุงูููุชุงุญ ุงูุฎุงุต ูุน ุฃู ุดุฎุต
- ุงุณุชุฎุฏู ุฃุฒุฑุงุฑ ุงููุณุฎ ุงููุฏูุฌุฉ ูุถูุงู ูุณุฎ ุงูุจูุงูุงุช ุจุดูู ุตุญูุญ

## ุงููููุงุช ุงููุญููุธุฉ

ูุชู ุญูุธ ุงููููุงุช ูู:
```
storage/app/zatca/
โโโ private.key                    # ุงูููุชุงุญ ุงูุฎุงุต ุงูุญุงูู
โโโ request.csr                    # ุทูุจ ุงูุดูุงุฏุฉ ุงูุญุงูู
โโโ private_key_2024-01-15_14-30-25.key  # ูุณุฎุฉ ูุคุฑุฎุฉ
โโโ request_2024-01-15_14-30-25.csr      # ูุณุฎุฉ ูุคุฑุฎุฉ
โโโ metadata_2024-01-15_14-30-25.json    # ูุนูููุงุช ูุตููุฉ
```

## API Endpoints

### ุนุฑุถ ุงููููุฐุฌ
```
GET /zatca
```

### ุฅูุดุงุก CSR
```
POST /zatca/generate-csr
Content-Type: application/json

{
  "organizationName": "ุดุฑูุฉ ุงูุชูููุฉ ุงููุชูุฏูุฉ",
  "organizationIdentifier": "399999999900003",
  "commonName": "TST-886431145-399999999900003",
  "businessCategory": "Supply activities to support transportation",
  "serialNumber": "1-TST",
  "address": "ุดุงุฑุน ุงูููู ููุฏุ ุญู ุงูุนููุงุ ุงูุฑูุงุถ 12244-2255ุ ุงูููููุฉ ุงูุนุฑุจูุฉ ุงูุณุนูุฏูุฉ",
  "simplified": false,
  "standard": true,
  "env": "Sandbox"
}
```

### ุฅุฑุณุงู CSR ุฅูู ZATCA
```
POST /zatca/send-csr
Content-Type: application/json

{
  "csrContent": "-----BEGIN CERTIFICATE REQUEST-----\n..."
}
```

### ูุนูููุงุช ุงูุญุงูุฉ
```
GET /zatca/status
```

### ุชุญููู ุงููููุงุช
```
GET /zatca/download/private-key  # ุชุญููู ุงูููุชุงุญ ุงูุฎุงุต
GET /zatca/download/csr          # ุชุญููู ุทูุจ ุงูุดูุงุฏุฉ
```

## ุงูุฎุทูุงุช ุงูุชุงููุฉ

### 1. ูู ุจูุฆุฉ ุงูุชุฌุฑูุจ
- ุชู ุฅูุดุงุก ุงููููุงุช ูุญููุงู ููุท
- ูููู ุงุฎุชุจุงุฑ ุงูุชูุงูู ูุน ุงููุธุงู
- ูุง ูุชู ุฅุฑุณุงู ุทูุจุงุช ุญููููุฉ ุฅูู ZATCA

### 2. ูู ุจูุฆุฉ ุงูุฅูุชุงุฌ
- ุณูุชู ุฅุฑุณุงู CSR ุฅูู ZATCA ุงููุนูู
- ุณุชุญุตู ุนูู ุดูุงุฏุฉ ุฑูููุฉ ุตุงูุญุฉ
- ุงุณุชุฎุฏู ุงูุดูุงุฏุฉ ูุชูููุน ุงูููุงุชูุฑ ุงูุฅููุชุฑูููุฉ

### 3. ุงูุชูุงูู ูุน ูุธุงู ุงูููุชุฑุฉ
ุจุนุฏ ุงูุญุตูู ุนูู ุงูุดูุงุฏุฉ ูู ZATCA:

1. ุงุญูุธ ุงูุดูุงุฏุฉ ูู ูุธุงูู
2. ุงุณุชุฎุฏู ุงูููุชุงุญ ุงูุฎุงุต + ุงูุดูุงุฏุฉ ูุชูููุน ุงูููุงุชูุฑ
3. ุฃุฑุณู ุงูููุงุชูุฑ ุงููููุนุฉ ุฅูู ZATCA ูููุตุงุฏูุฉ

## ุงูุฃูุงู ูุงูุญูุงูุฉ

### ๐ ุฃูุถู ุงูููุงุฑุณุงุช
- ุงุญูุธ ุงูููุชุงุญ ุงูุฎุงุต ูู ููุงู ุขูู ููุดูุฑ
- ุงุณุชุฎุฏู HTTPS ุฏุงุฆูุงู ูู ุจูุฆุฉ ุงูุฅูุชุงุฌ
- ูู ุจุนูู ูุณุฎ ุงุญุชูุงุทูุฉ ุฏูุฑูุฉ ูููููุงุช
- ุฑุงุฌุน ุณุฌูุงุช ุงููุธุงู ุจุงูุชุธุงู

### ๐ก๏ธ ุฅุฏุงุฑุฉ ุงููุตูู
- ูุตุฑ ุงููุตูู ูููููุฐุฌ ุนูู ุงููุณุชุฎุฏููู ุงููุฎูููู
- ุงุณุชุฎุฏู ุงููุตุงุฏูุฉ ูุชุนุฏุฏุฉ ุงูุนูุงูู
- ุฑุงูุจ ูุญุงููุงุช ุงููุตูู ุบูุฑ ุงููุตุฑุญุฉ

## ุงุณุชูุดุงู ุงูุฃุฎุทุงุก

### ูุดุงูู ุดุงุฆุนุฉ

#### ุฎุทุฃ ูู ุฅูุดุงุก CSR
```
ุฎุทุฃ ุฃุซูุงุก ุชูููุฏ CSR: Invalid organization identifier
```
**ุงูุญู**: ุชุฃูุฏ ูู ุตุญุฉ ุฑูู ุถุฑูุจุฉ ุงููููุฉ ุงููุถุงูุฉ (15 ุฑูู ููุท)

#### ูุดููุฉ ูู ุญูุธ ุงููููุงุช
```
ุฎุทุฃ ุฃุซูุงุก ุชูููุฏ CSR: Permission denied
```
**ุงูุญู**: ุชุฃูุฏ ูู ุตูุงุญูุงุช ูุฌูุฏ storage
```bash
chmod -R 755 storage/app/zatca
```

#### ูุดู ูู ุฅุฑุณุงู CSR
```
ุญุฏุซ ุฎุทุฃ ุฃุซูุงุก ุฅุฑุณุงู ุทูุจ ุงูุดูุงุฏุฉ: Connection timeout
```
**ุงูุญู**: ุชุญูู ูู ุงุชุตุงู ุงูุฅูุชุฑูุช ูุฅุนุฏุงุฏุงุช ุงูู firewall

### ุณุฌูุงุช ุงููุธุงู
ุชุญูู ูู ุณุฌูุงุช Laravel:
```bash
tail -f storage/logs/laravel.log | grep ZATCA
```

## ุงูุฏุนู ูุงููุณุงุนุฏุฉ

ููุญุตูู ุนูู ุงููุณุงุนุฏุฉ:
1. ุฑุงุฌุน ูุซุงุฆู Salla/ZATCA ุงูุฑุณููุฉ
2. ุชุญูู ูู ุฏููู ZATCA ุงูููู
3. ุฑุงุฌุน ุณุฌูุงุช ุงููุธุงู ููุชูุงุตูู

---

## ููุงุญุธุงุช ูููุฉ

โ๏ธ **ุชุญุฐูุฑ**: ูุฐุง ุงููุธุงู ูุฎุตุต ูุฅูุดุงุก ุทูุจุงุช ุงูุดูุงุฏุฉ ููุท. ููุญุตูู ุนูู ุดูุงุฏุฉ ุตุงูุญุฉุ ูุฌุจ ุฅุฑุณุงู CSR ุฅูู ZATCA ูุงุชุจุงุน ุฅุฌุฑุงุกุงุชูู ุงูุฑุณููุฉ.

โ **ูุฌุญ ุงูุชุซุจูุช**: ุฅุฐุง ูุงู ุจุฅููุงูู ุฑุคูุฉ ุงููููุฐุฌ ูุงูุชูุงุนู ูุนูุ ููุฏ ุชู ุงูุชุซุจูุช ุจูุฌุงุญ.

๐ง **ุงูุชูุงุตู**: ูุฃู ุงุณุชูุณุงุฑุงุช ุชูููุฉุ ุฑุงุฌุน ูุซุงุฆู Laravel ู Salla/ZATCA ุงูุฑุณููุฉ.
