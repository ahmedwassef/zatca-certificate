# نظام إعداد شهادة ZATCA - دليل الاستخدام

## نظرة عامة

تم إنشاء نظام شامل لإعداد وإدارة شهادات هيئة الزكاة والضريبة والجمارك السعودية (ZATCA) باستخدام حزمة Salla/ZATCA. يوفر النظام واجهة مستخدم عربية متكاملة لإنشاء طلبات الشهادة (CSR) وإدارة الملفات المطلوبة.

## الميزات الرئيسية

### 🎯 النموذج التفاعلي
- واجهة مستخدم عربية (RTL) مصممة خصيصاً للمستخدمين السعوديين
- فئات نشاط تجاري محددة مسبقاً
- تحقق تلقائي من صحة البيانات
- تنسيق تلقائي لرقم ضريبة القيمة المضافة

### 🔐 إدارة الشهادات
- إنشاء المفتاح الخاص (Private Key) بشكل آمن
- توليد طلب الشهادة (CSR) حسب معايير ZATCA
- حفظ تلقائي للملفات مع timestamp
- إمكانية تحميل الملفات بصيغ متعددة

### 🌍 بيئات متعددة
- دعم بيئة التجريب (Sandbox)
- دعم بيئة الإنتاج (Production)
- محاكاة إرسال للـ API في بيئة التجريب

### 📊 تتبع ومراقبة
- سجلات مفصلة للعمليات
- معلومات وصفية للملفات المنشأة
- إدارة تلقائية للملفات القديمة

## التثبيت والإعداد

### 1. تأكد من وجود الحزم المطلوبة

```bash
composer install
```

الحزم المطلوبة:
- `salla/zatca: ^3.0` (مثبتة مسبقاً)
- Laravel Framework ^11.31
- PHP ^8.2

### 2. إعداد متغيرات البيئة

أضف هذه المتغيرات إلى ملف `.env`:

```env
# ZATCA Configuration
ZATCA_ENV=sandbox
ZATCA_SANDBOX_API_URL=https://sandbox-api.fatoora.zatca.gov.sa
ZATCA_SIMULATION_API_URL=https://simulation-api.fatoora.zatca.gov.sa
ZATCA_PROD_API_URL=https://api.fatoora.zatca.gov.sa

# Optional: Pre-fill organization data
ORG_IDENTIFIER=399999999900003
ZATCA_COMMON_NAME=TST-886431145-399999999900003
ZATCA_SERIAL_NUMBER=1-TST
ZATCA_BUSINESS_CATEGORY=Supply activities to support transportation
```

### 3. إنشاء مجلد التخزين

```bash
php artisan storage:link
mkdir -p storage/app/zatca
chmod 755 storage/app/zatca
```

## الاستخدام

### 1. الوصول للنموذج

زر الرابط التالي في المتصفح:
```
http://your-domain.com/zatca
```

أو للتطوير المحلي:
```
http://localhost:8000/zatca
```

### 2. ملء النموذج

#### معلومات الشركة
- **اسم الشركة**: الاسم التجاري للشركة
- **الاسم المشترك**: معرف فريد للشهادة (يُنشأ تلقائياً)
- **معرف الشركة**: رقم ضريبة القيمة المضافة (15 رقم)
- **فئة النشاط التجاري**: اختر من القائمة المحددة مسبقاً

#### معلومات الرقم التسلسلي
- **الرقم التسلسلي**: معرف الجهاز أو النظام (اسم الحل: TST، الإصدار: 1.0)

#### العنوان المسجل
- **العنوان الكامل**: العنوان المسجل في السجل التجاري

#### أنواع الفواتير
- **الفواتير المبسطة**: للمبيعات المباشرة (B2C)
- **الفواتير المعيارية**: للمبيعات للشركات (B2B)

### 3. إنشاء الشهادة

1. انقر على "إنشاء طلب الشهادة (CSR)"
2. انتظر حتى اكتمال العملية
3. ستظهر النتائج تلقائياً في الأسفل

### 4. حفظ الملفات

عند إنشاء الشهادة بنجاح، ستحصل على:

#### المفتاح الخاص (Private Key)
```
-----BEGIN PRIVATE KEY-----
MIIEvgIBADANBgkqhkiG9w0BAQEFAASCBKgwggSkAgEAAoIBAQC...
-----END PRIVATE KEY-----
```

#### طلب الشهادة (CSR)
```
-----BEGIN CERTIFICATE REQUEST-----
MIICXTCCAUUCAQAwGDEWMBQGA1UEAwwNVFNULTg4NjQzMTE0NTCCASIwDQYJKoZI...
-----END CERTIFICATE REQUEST-----
```

**⚠️ مهم جداً:**
- احفظ المفتاح الخاص في مكان آمن
- لا تشارك المفتاح الخاص مع أي شخص
- استخدم أزرار النسخ المدمجة لضمان نسخ البيانات بشكل صحيح

## الملفات المحفوظة

يتم حفظ الملفات في:
```
storage/app/zatca/
├── private.key                    # المفتاح الخاص الحالي
├── request.csr                    # طلب الشهادة الحالي
├── private_key_2024-01-15_14-30-25.key  # نسخة مؤرخة
├── request_2024-01-15_14-30-25.csr      # نسخة مؤرخة
└── metadata_2024-01-15_14-30-25.json    # معلومات وصفية
```

## API Endpoints

### عرض النموذج
```
GET /zatca
```

### إنشاء CSR
```
POST /zatca/generate-csr
Content-Type: application/json

{
  "organizationName": "شركة التقنية المتقدمة",
  "organizationIdentifier": "399999999900003",
  "commonName": "TST-886431145-399999999900003",
  "businessCategory": "Supply activities to support transportation",
  "serialNumber": "1-TST",
  "address": "شارع الملك فهد، حي العليا، الرياض 12244-2255، المملكة العربية السعودية",
  "simplified": false,
  "standard": true,
  "env": "Sandbox"
}
```

### إرسال CSR إلى ZATCA
```
POST /zatca/send-csr
Content-Type: application/json

{
  "csrContent": "-----BEGIN CERTIFICATE REQUEST-----\n..."
}
```

### معلومات الحالة
```
GET /zatca/status
```

### تحميل الملفات
```
GET /zatca/download/private-key  # تحميل المفتاح الخاص
GET /zatca/download/csr          # تحميل طلب الشهادة
```

## الخطوات التالية

### 1. في بيئة التجريب
- تم إنشاء الملفات محلياً فقط
- يمكن اختبار التكامل مع النظام
- لا يتم إرسال طلبات حقيقية إلى ZATCA

### 2. في بيئة الإنتاج
- سيتم إرسال CSR إلى ZATCA الفعلي
- ستحصل على شهادة رقمية صالحة
- استخدم الشهادة لتوقيع الفواتير الإلكترونية

### 3. التكامل مع نظام الفوترة
بعد الحصول على الشهادة من ZATCA:

1. احفظ الشهادة في نظامك
2. استخدم المفتاح الخاص + الشهادة لتوقيع الفواتير
3. أرسل الفواتير الموقعة إلى ZATCA للمصادقة

## الأمان والحماية

### 🔒 أفضل الممارسات
- احفظ المفتاح الخاص في مكان آمن ومشفر
- استخدم HTTPS دائماً في بيئة الإنتاج
- قم بعمل نسخ احتياطية دورية للملفات
- راجع سجلات النظام بانتظام

### 🛡️ إدارة الوصول
- قصر الوصول للنموذج على المستخدمين المخولين
- استخدم المصادقة متعددة العوامل
- راقب محاولات الوصول غير المصرحة

## استكشاف الأخطاء

### مشاكل شائعة

#### خطأ في إنشاء CSR
```
خطأ أثناء توليد CSR: Invalid organization identifier
```
**الحل**: تأكد من صحة رقم ضريبة القيمة المضافة (15 رقم فقط)

#### مشكلة في حفظ الملفات
```
خطأ أثناء توليد CSR: Permission denied
```
**الحل**: تأكد من صلاحيات مجلد storage
```bash
chmod -R 755 storage/app/zatca
```

#### فشل في إرسال CSR
```
حدث خطأ أثناء إرسال طلب الشهادة: Connection timeout
```
**الحل**: تحقق من اتصال الإنترنت وإعدادات الـ firewall

### سجلات النظام
تحقق من سجلات Laravel:
```bash
tail -f storage/logs/laravel.log | grep ZATCA
```

## الدعم والمساعدة

للحصول على المساعدة:
1. راجع وثائق Salla/ZATCA الرسمية
2. تحقق من دليل ZATCA الفني
3. راجع سجلات النظام للتفاصيل

---

## ملاحظات مهمة

⚠️ **تحذير**: هذا النظام مخصص لإنشاء طلبات الشهادة فقط. للحصول على شهادة صالحة، يجب إرسال CSR إلى ZATCA واتباع إجراءاتهم الرسمية.

✅ **نجح التثبيت**: إذا كان بإمكانك رؤية النموذج والتفاعل معه، فقد تم التثبيت بنجاح.

📧 **التواصل**: لأي استفسارات تقنية، راجع وثائق Laravel و Salla/ZATCA الرسمية.
